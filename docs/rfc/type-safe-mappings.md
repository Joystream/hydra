# Strongly typed mappings

## Summary

The mappings define how the processor should handle the events. This proposal describes how the event can be auto-generated to make it strongly typed.

## Goals and motivation

1) Manual type conversion from `SubstrateEvent` currently passed to the mappings is error-prone

2) Runtime changes and deserialization issues are easy to spot

## Urgency

Subjectively, strong typings is a must if a large collection of mappings is going to be maintained for a long time.

## Detailed Design

The codegen will perform the following steps:

1) Define all (event, extrinsic) pairs that are going to be handled according to the manifest file. Extrinsic may be optional
2) Lookup the definitions and argument types in the metadata file, both for the event and the extrinsic. If the extrinsic was not specified, leave it as optional arbitrary `AnyJSON`.
3) Generate classes extending `SubstrateEvent` with `get` methods performing the deserialization and type-casting. The classes are created using [TypeRegistry](https://github.com/polkadot-js/api/blob/master/packages/types/src/types/registry.ts) interface from `@polkadot/api`. By default, it contains all the base substrate type definitions but my be extended with custom types. This assumes that the required types can be created by name via `typeRegistry.createType(type, value)`. `typeRegistry` will be declared in `@dzlzv/hydra-common` and must be defined and exported in the processor runner.
4) The types and interfaces must be available for import from `./types.ts`. The standard polkadot types should be re-exported together with additional custom and manually defined types and interfaces.
5) The property names will be derived using the `name` property (if present), otherwise by lowercasing the type. If there are several properties of the same type, prefix with a number.

Example of the strongly typed event and the autogenerated properties:

```typescript
// typeRegistry is declared there but must be defined elsewhere
import { typeRegistry, SubstrateEvent } from '@dzlzv/hydra-common'
// types.ts must reexport these types from @polkadot/api/intefaces
import { AccountId, Balance, Compact } from '../types'

export class BalancesBalanceSetEvent extends SubstrateEvent {

    get params(): BalanceSet__Params {
        return new BalanceSet__Params(this)
    }  

    get callArgs(): BalanceSet__CallArgs {
        return new BalanceSet__CallArgs(this)
    }
}

export class BalanceSet__Params {
  _event: BalancesBalanceSetEvent;

  constructor(event: BalancesBalanceSetEvent) {
    this._event = event;
  }
  
  get accountId(): AccountId {
    return typeRegistry.createType('AccoundId', this._event.params[0])
  }

  get balance0(): Balance {
    return typeRegistry.createType('Balance', this._event.params[1])
  }

  get balance1(): Balance {
    return typeRegistry.createType('Balance', this._event.params[2])
  }
}

export class BalanceSet__CallArgs {
  _event: BalancesBalanceSetEvent;

  constructor(event: BalancesBalanceSetEvent) {
    this._event = event;
    if (this._event.extrinsic === undefined) {
       throw new Error(`Extrinsic balances_set is expected`)
    }
  }
  
  get who(): AccountId {
    return typeRegistry.createType('LookupSource', this._event.extrinsic?.args[0])
  }

  get new_free(): Compact<Balance> {
    return typeRegistry.createType('Compact<Balance>', this._event.extrinsic?.args[1])
  }

  get new_reserved(): Compact<Balance> {
    return typeRegistry.createType('Compact<Balance>', this._event.extrinsic?.args[2])
  }
}
```
